#!/bin/bash

# ==========================================
# QUANTICAST AI - Automated Setup Script
# Version: 1.2.0 (Working Version)
# ==========================================

echo "üöÄ Initializing QUANTICAST AI Setup..."

# 1. Project Scaffolding
mkdir -p quanticast-ai/src/components
mkdir -p quanticast-ai/src/services
cd quanticast-ai

echo "üìÇ Created directory structure..."

# 2. Package Configuration
echo "üìù Generating configuration files..."

cat << 'EOF' > package.json
{
  "name": "quanticast-ai",
  "private": true,
  "version": "1.2.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^0.1.1",
    "lucide-react": "^0.344.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.2.2",
    "vite": "^5.1.4"
  }
}
EOF

cat << 'EOF' > tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
EOF

cat << 'EOF' > tsconfig.node.json
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
EOF

cat << 'EOF' > vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  envPrefix: 'VITE_',
})
EOF

cat << 'EOF' > tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace'],
      },
      colors: {
        'fin-dark': '#0a0a0c',
        'fin-panel': '#131316',
        'fin-card': '#1c1c21',
        'fin-border': '#27272a',
        'fin-bull': '#10b981',
        'fin-bear': '#f43f5e',
        'fin-accent': '#3b82f6',
      },
      animation: {
        'fade-in': 'fadeIn 0.5s ease-out',
        'fade-in-up': 'fadeInUp 0.5s ease-out',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        fadeInUp: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
      },
    },
  },
  plugins: [],
}
EOF

cat << 'EOF' > postcss.config.js
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
EOF

cat << 'EOF' > index.html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QUANTICAST AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { background-color: #0a0a0c; color: #e4e4e7; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
EOF

cat << 'EOF' > .env
VITE_API_KEY=your_gemini_api_key_here
EOF

# 3. Source Code Generation
echo "üíª Writing source code..."

# --- types.ts ---
cat << 'EOF' > src/types.ts
export enum StrategyType {
  SMC = 'SMC',
  LIQUIDITY_FLOW = 'LIQUIDITY_FLOW',
  CAN_SLIM = 'CAN_SLIM',
  VCP = 'VCP',
  DOW = 'DOW',
  ELLIOTT = 'ELLIOTT',
  GANN = 'GANN',
  WYCKOFF = 'WYCKOFF',
  INVESTMENT_CLOCK = 'INVESTMENT_CLOCK',
  LPPL = 'LPPL',
  INTERMARKET = 'INTERMARKET',
  FRACTAL = 'FRACTAL',
  SENTIMENT = 'SENTIMENT',
}

export interface ChartMetadata {
  ticker: string;
  timeframe: string;
  current_price: number;
  chart_type: string;
}

export interface ValidationResponse {
  is_valid_chart: boolean;
  rejection_reason: string | null;
  metadata?: ChartMetadata;
}

export interface VisualAnalysis {
  trend: string;
  patterns_detected: string[];
  key_levels_visible: { [key: string]: string };
  chart_quality_check: string;
}

export interface AgentGrounding {
  search_queries_run: string[];
  critical_findings: string;
  divergence_warning: boolean;
}

export interface TradePlanNew {
  bias: string;
  entry_zone: string;
  stop_loss: string;
  take_profit_1: string;
  take_profit_2: string;
}

export interface ExternalData {
  search_summary: string;
  market_sentiment: 'Risk-On' | 'Risk-Off' | 'Neutral';
  sources: Array<{ title: string; uri: string }>;
}

export interface GradingData {
  grade: "A+" | "A" | "B" | "C";
  headline: string;
  visual_score: number;
  data_score: number;
  sentiment_score: number;
  risk_reward_score: number;
  momentum_score: number;
  action_plan: {
    action: "BUY STOP" | "SELL STOP" | "LIMIT ORDER" | "WAIT" | "NO TRADE";
    price: string;
    stop_loss: string;
    target: string;
  };
  reasoning: string;
}

export interface FinalAnalysis {
  meta: {
    ticker: string;
    strategy_used: string;
    timestamp: string;
  };
  grading: GradingData;
  visual_findings?: string;
  grounding_findings?: string;
  visual_analysis: VisualAnalysis;
  agent_grounding: AgentGrounding;
  trade_plan: TradePlanNew;
  external_data?: ExternalData;
  confidence_score: number;
  final_verdict: string;
}

export interface Report {
  id: string;
  timestamp: number;
  ticker: string;
  strategy: StrategyType;
  grade: string;
  bias: string;
  data: FinalAnalysis;
  validation: ValidationResponse;
}

export interface AppState {
  step: 'UPLOAD' | 'VALIDATING' | 'ANALYZING' | 'RESULTS' | 'ERROR' | 'REPORTS';
  selectedStrategy: StrategyType;
  imageFile: File | null;
  imagePreviewUrl: string | null;
  validationData: ValidationResponse | null;
  analysisData: FinalAnalysis | null;
  error: string | null;
  logs: string[];
  history: Report[];
}

// Global declaration for experimental ImageCapture API
declare global {
  class ImageCapture {
    constructor(videoTrack: MediaStreamTrack);
    grabFrame(): Promise<ImageBitmap>;
  }
}
EOF

# --- constants.ts ---
cat << 'EOF' > src/constants.ts
import { StrategyType } from "./types";

export const SYSTEM_INSTRUCTION = `
Role: You are a Senior Portfolio Manager at a quantitative hedge fund. 
Your goal is NOT just to find trades, but to **GRADE** them based on quality using a strict Risk Management Matrix.

**THE CORE PHILOSOPHY: PRICE IN THE FUTURE**
Markets are discounting mechanisms. A perfect chart (Past) is meaningless if a Binary Event (Future) is imminent.
You must assess "Forward-Looking Risk" (Event Risk, Implied Volatility, Earnings Revisions) before assigning a Grade.

**YOUR GRADING RUBRIC:**
- **GRADE A+ (THE UNICORN):** Visual Pattern perfect + Forward Data CLEAR (No event risk). Max Size.
- **GRADE A (HIGH PROBABILITY):** Visual Strong + Data Neutral. Standard risk.
- **GRADE B (SPECULATIVE):** Visual Messy + Event Risk ELEVATED. Half Size.
- **GRADE C (HIGH RISK / WARNING):** Ambiguous OR Imminent Event Risk. PROVIDE PLAN BUT MARK AS HIGH RISK/PAPER TRADE ONLY.

Methodology: Combine Computer Vision (Technical) + Real-Time Data (Search) + Forward Expectations.
Constraints: Do NOT hallucinate data. Always provide specific PRICE VALUES. Output valid JSON.
`;

export const VALIDATION_PROMPT = `
Analyze the attached image.
Task: Validate if this is a financial chart and extract metadata.
Validation Checklist:
1. Is a Ticker Symbol clearly visible?
2. Is the Timeframe visible?
3. Are X/Y axes legible?
Output JSON: { "is_valid_chart": boolean, "rejection_reason": string | null, "metadata": { "ticker": string, "timeframe": string, "current_price": number, "chart_type": string } }
`;

const STRATEGY_DEFINITIONS = {
  [StrategyType.SMC]: {
    style: "Intraday Scalping",
    vision_task: "Identify Liquidity Sweeps, FVGs, and MSS.",
    search_task: "1. Check Economic Calendar (Next 48h). 2. Check Implied Volatility.",
    grading_criteria: "A+: Sweep + FVG + No News. C: Messy or High Impact News."
  },
  [StrategyType.LIQUIDITY_FLOW]: {
    style: "Day Trading / Scalping",
    vision_task: "Identify 'Turtle Soup' (Failed Breakouts), 'Bart Simpson' patterns, and Liquidity Sweeps.",
    search_task: "1. Crypto: Bitcoin Funding Rates. 2. Gold/FX: London Fix timing. 3. Indices: NYSE TICK extremes.",
    grading_criteria: "A+: Visual Sweep + Funding Squeeze. C: Breakout without Volume."
  },
  [StrategyType.VCP]: {
    style: "Momentum Swing",
    vision_task: "Identify Volatility Contraction and Volume Dry-up.",
    search_task: "1. Sector Leading? 2. Earnings Date? 3. IV Rank?",
    grading_criteria: "A+: 3+ Contractions + Leading Sector. C: Loose Pattern or Earnings Imminent."
  },
  [StrategyType.CAN_SLIM]: {
    style: "Growth Swing",
    vision_task: "Bullish patterns (Cup & Handle). Volume spikes on up-days.",
    search_task: "1. EPS Growth. 2. Analyst Revisions (Up/Down). 3. Forward Guidance.",
    grading_criteria: "A+: Pattern + Revisions UP. C: Revisions DOWN."
  },
  [StrategyType.ELLIOTT]: {
    style: "Cycle Analysis",
    vision_task: "5-wave motive or 3-wave corrective structures.",
    search_task: "1. Elliott Wave Consensus. 2. Fibonacci Time Zones.",
    grading_criteria: "A+: Clean Impulse + Consensus Alignment."
  },
  [StrategyType.DOW]: {
    style: "Macro Trend",
    vision_task: "Primary trend (HH/HL) and Volume.",
    search_task: "1. Transport vs Industrial Correlation. 2. Bond Yield Curve.",
    grading_criteria: "A+: Trend + Volume + Yield Curve Normal."
  },
  [StrategyType.GANN]: {
    style: "Geometric Time/Price",
    vision_task: "Swing High/Low dates and angles.",
    search_task: "1. Square of 9 Levels. 2. Seasonal Dates.",
    grading_criteria: "A+: Price/Time Squaring."
  },
  [StrategyType.WYCKOFF]: {
    style: "Institutional Cycle",
    vision_task: "Accumulation vs Distribution (Springs/Upthrusts).",
    search_task: "1. Dark Pool Index. 2. Insider Transactions.",
    grading_criteria: "A+: Phase C Spring + Insider Buying."
  },
  [StrategyType.INVESTMENT_CLOCK]: {
    style: "Macro Forecasting",
    vision_task: "Primary trend and pivots.",
    search_task: "1. GDP/CPI. 2. Fed Funds Futures pricing.",
    grading_criteria: "A+: Visuals align with Cycle Phase."
  },
  [StrategyType.LPPL]: {
    style: "Crash Prediction",
    vision_task: "Parabolic action and oscillations.",
    search_task: "1. Fear & Greed Index. 2. Option Skew.",
    grading_criteria: "A+: Vertical Slope + Extreme Greed."
  },
  [StrategyType.INTERMARKET]: {
    style: "Correlation Arbitrage",
    vision_task: "Trend identification.",
    search_task: "1. Correlated Assets. 2. Real Yields.",
    grading_criteria: "A+: Trend Confirmed by Real Yields."
  },
  [StrategyType.FRACTAL]: {
    style: "Regime Forecasting",
    vision_task: "Chart texture (Choppy vs Smooth).",
    search_task: "Hurst Exponent or Volatility Forecast.",
    grading_criteria: "A+: Texture matches Hurst."
  },
  [StrategyType.SENTIMENT]: {
    style: "Contrarian",
    vision_task: "Capitulation candles.",
    search_task: "1. AAII Sentiment. 2. Put/Call Ratio.",
    grading_criteria: "A+: Panic + High P/C Ratio."
  }
};

export const getAnalysisPrompt = (strategy: StrategyType, ticker: string) => {
  const strat = STRATEGY_DEFINITIONS[strategy] || STRATEGY_DEFINITIONS[StrategyType.SMC];

  return `
  Analyze the uploaded chart for ${ticker} using the ${strategy} framework.
  CONTEXT: TRADING STYLE: ${strat.style}. RUBRIC: ${strat.grading_criteria}
  
  STEP 1: VISUAL ANALYSIS (The "What")
  ${strat.vision_task}
  
  STEP 2: FORWARD-LOOKING RISK CHECK (The "Why")
  Use googleSearch to find: ${strat.search_task}
  
  STEP 3: SYNTHESIS & GRADING
  Combine Visuals with Forward Data. Downgrade if Event Risk imminent.
  
  LOCKED JSON SCHEMA:
  {
    "meta": { "ticker": "${ticker}", "strategy_used": "${strategy}", "timestamp": "UTC_NOW" },
    "grading": {
      "grade": "A+", "headline": "Summary", "visual_score": 8, "data_score": 7, "sentiment_score": 6, "risk_reward_score": 9, "momentum_score": 8,
      "action_plan": { "action": "BUY STOP", "price": "150.20", "stop_loss": "145.50", "target": "165.00" },
      "reasoning": "Explanation"
    },
    "visual_findings": "Detailed text", "grounding_findings": "Detailed text",
    "visual_analysis": { "trend": "Bullish", "patterns_detected": [], "key_levels_visible": { "resistance": "", "support": "" }, "chart_quality_check": "Pass" },
    "agent_grounding": { "search_queries_run": [], "critical_findings": "Summary", "divergence_warning": false },
    "trade_plan": { "bias": "LONG", "entry_zone": "", "stop_loss": "", "take_profit_1": "", "take_profit_2": "" },
    "confidence_score": 85, "final_verdict": "EXECUTE"
  }
  `;
};
EOF

# --- services/geminiService.ts ---
cat << 'EOF' > src/services/geminiService.ts
import { GoogleGenAI } from "@google/genai";
import { SYSTEM_INSTRUCTION, VALIDATION_PROMPT, getAnalysisPrompt } from "../constants";
import { StrategyType, ValidationResponse, FinalAnalysis } from "../types";

const cleanJson = (text: string): string => {
  const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
  if (jsonMatch && jsonMatch[1]) return jsonMatch[1].trim();
  const start = text.indexOf('{');
  const end = text.lastIndexOf('}');
  if (start !== -1 && end !== -1) return text.substring(start, end + 1);
  return text.trim();
};

const fileToGenerativePart = async (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve((reader.result as string).split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

export const validateChart = async (file: File): Promise<ValidationResponse> => {
  const apiKey = import.meta.env.VITE_API_KEY;
  if (!apiKey) throw new Error("API Key not found");
  
  const ai = new GoogleGenAI({ apiKey });
  const imageBase64 = await fileToGenerativePart(file);
  
  const response = await ai.models.generateContent({
    model: "gemini-2.5-flash",
    config: { systemInstruction: SYSTEM_INSTRUCTION, temperature: 0.1 },
    contents: { parts: [{ inlineData: { mimeType: file.type, data: imageBase64 } }, { text: VALIDATION_PROMPT }] }
  });
  
  return JSON.parse(cleanJson(response.text || "{}")) as ValidationResponse;
};

export const analyzeChart = async (file: File, strategy: StrategyType, metadata: any): Promise<FinalAnalysis> => {
  const apiKey = import.meta.env.VITE_API_KEY;
  if (!apiKey) throw new Error("API Key not found");
  
  const ai = new GoogleGenAI({ apiKey });
  const imageBase64 = await fileToGenerativePart(file);
  const prompt = getAnalysisPrompt(strategy, metadata.ticker);
  
  const response = await ai.models.generateContent({
    model: "gemini-2.5-flash",
    config: { systemInstruction: SYSTEM_INSTRUCTION, temperature: 0.4, tools: [{ googleSearch: {} }] },
    contents: { parts: [{ inlineData: { mimeType: file.type, data: imageBase64 } }, { text: prompt }] }
  });

  const parsedData = JSON.parse(cleanJson(response.text || "{}")) as FinalAnalysis;
  const sources = response.candidates?.[0]?.groundingMetadata?.groundingChunks
    ?.map(c => c.web).filter(w => w?.uri && w?.title).map(w => ({ title: w!.title!, uri: w!.uri! }));
  
  if (parsedData.external_data && sources) parsedData.external_data.sources = sources;
  return parsedData;
};
EOF

# --- Components ---
# StrategySelector.tsx
cat << 'EOF' > src/components/StrategySelector.tsx
import React from 'react';
import { StrategyType } from '../types';
import { Crosshair, Activity, BarChart3, Waves, TrendingUp, Clock, Zap, Layers, Globe, Scale, PieChart, Rocket, ArrowRightLeft, Cpu, Users } from 'lucide-react';

interface Props { selected: StrategyType; onSelect: (s: StrategyType) => void; }

const groups = [
  {
    title: "Day Trading", description: "Intraday liquidity & rapid execution", icon: <Zap className="w-5 h-5 text-yellow-500" />,
    items: [
      { id: StrategyType.SMC, name: "SMC", desc: "Liquidity Sweeps & FVGs", icon: <Crosshair className="w-5 h-5" /> },
      { id: StrategyType.LIQUIDITY_FLOW, name: "Liquidity Flow", desc: "Turtle Soup & Funding Rates", icon: <Waves className="w-5 h-5" /> }
    ]
  },
  {
    title: "Swing Trading", description: "Multi-day structural breakouts", icon: <Layers className="w-5 h-5 text-blue-500" />,
    items: [
      { id: StrategyType.VCP, name: "VCP", desc: "Volatility Contraction", icon: <Activity className="w-5 h-5" /> },
      { id: StrategyType.CAN_SLIM, name: "CAN SLIM", desc: "Growth + Fundamentals", icon: <TrendingUp className="w-5 h-5" /> },
      { id: StrategyType.ELLIOTT, name: "Elliott Wave", desc: "Cycle Counting", icon: <Waves className="w-5 h-5" /> }
    ]
  },
  {
    title: "Macro & Cycles", description: "Long-term trends", icon: <Globe className="w-5 h-5 text-purple-500" />,
    items: [
      { id: StrategyType.DOW, name: "Dow Theory", desc: "Primary Trend", icon: <BarChart3 className="w-5 h-5" /> },
      { id: StrategyType.GANN, name: "Gann Theory", desc: "Time/Price Geometry", icon: <Clock className="w-5 h-5" /> },
      { id: StrategyType.WYCKOFF, name: "Wyckoff", desc: "Accumulation/Distribution", icon: <Scale className="w-5 h-5" /> }
    ]
  },
  {
    title: "Forecasting", description: "Predictive regimes", icon: <PieChart className="w-5 h-5 text-pink-500" />,
    items: [
      { id: StrategyType.INVESTMENT_CLOCK, name: "Inv. Clock", desc: "Macro Asset Allocation", icon: <PieChart className="w-5 h-5" /> },
      { id: StrategyType.LPPL, name: "LPPL Bubble", desc: "Crash Prediction", icon: <Rocket className="w-5 h-5" /> },
      { id: StrategyType.INTERMARKET, name: "Intermarket", desc: "Cross-Asset Correlations", icon: <ArrowRightLeft className="w-5 h-5" /> },
      { id: StrategyType.FRACTAL, name: "Fractal", desc: "Hurst Exponent", icon: <Cpu className="w-5 h-5" /> },
      { id: StrategyType.SENTIMENT, name: "Sentiment", desc: "Contrarian Model", icon: <Users className="w-5 h-5" /> }
    ]
  }
];

export const StrategySelector: React.FC<Props> = ({ selected, onSelect }) => {
  return (
    <div className="w-full space-y-8">
      {groups.map((group, idx) => (
        <div key={idx} className="animate-fade-in-up">
          <div className="flex items-center gap-2 mb-4 ml-1">
            {group.icon} <h3 className="text-lg font-bold text-gray-200">{group.title}</h3>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {group.items.map((strat) => (
              <button key={strat.id} onClick={() => onSelect(strat.id)} className={`p-4 rounded-xl border text-left transition-all ${selected === strat.id ? 'bg-fin-panel border-fin-accent shadow-[0_0_15px_rgba(59,130,246,0.2)]' : 'bg-fin-dark border-fin-border hover:bg-fin-card'}`}>
                <div className="flex justify-between mb-2">
                  <span className={selected === strat.id ? 'text-fin-accent' : 'text-gray-400'}>{strat.icon}</span>
                  {selected === strat.id && <span className="text-fin-accent text-[10px] font-mono uppercase">Active</span>}
                </div>
                <div><h3 className="text-sm font-bold text-white">{strat.name}</h3><p className="text-xs text-gray-500">{strat.desc}</p></div>
              </button>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
};
EOF

# AnalysisView.tsx
cat << 'EOF' > src/components/AnalysisView.tsx
import React from 'react';
import { FinalAnalysis, ValidationResponse, StrategyType } from '../types';
import { ShieldAlert, Target, FileText, CheckCircle2, Globe, ExternalLink, AlertTriangle, XCircle, Activity, ImageOff } from 'lucide-react';

interface Props { validation: ValidationResponse; analysis: FinalAnalysis; imagePreview: string | null; strategy: StrategyType; }

const RadarChart: React.FC<{ visual: number; data: number; sentiment: number; risk: number; momentum: number; }> = ({ visual, data, sentiment, risk, momentum }) => {
  const size = 200, center = 100, radius = 80;
  const getPoint = (score: number, angle: number) => {
    const r = (score / 10) * radius;
    return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`;
  };
  const angles = [-Math.PI/2, -Math.PI/2 + (2*Math.PI)/5, -Math.PI/2 + (4*Math.PI)/5, -Math.PI/2 + (6*Math.PI)/5, -Math.PI/2 + (8*Math.PI)/5];
  const pathData = [getPoint(visual, angles[0]), getPoint(data, angles[1]), getPoint(momentum, angles[2]), getPoint(risk, angles[3]), getPoint(sentiment, angles[4])].join(" ");
  
  return (
    <svg width={size} height={size} viewBox="0 0 200 200" className="mx-auto">
      {[20, 40, 60, 80].map((r, i) => (
        <polygon key={i} points={angles.map(a => `${center + r * Math.cos(a)},${center + r * Math.sin(a)}`).join(" ")} fill="none" stroke="#27272a" />
      ))}
      <polygon points={pathData} fill="rgba(16, 185, 129, 0.2)" stroke="#10b981" strokeWidth="2" className="drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]" />
    </svg>
  );
};

export const AnalysisView: React.FC<Props> = ({ validation, analysis, imagePreview, strategy }) => {
  const { grading, trade_plan, visual_analysis, external_data } = analysis;
  const isTradeable = !grading.grade.includes("C");

  return (
    <div className="w-full pb-20 animate-fade-in">
      {/* Header */}
      <div className="flex justify-between items-center mb-8 pb-6 border-b border-fin-border">
        <div>
          <h1 className="text-3xl font-bold text-white font-mono">{validation.metadata?.ticker} <span className="text-gray-500">/ {validation.metadata?.timeframe}</span></h1>
          <span className="text-fin-accent text-sm font-mono">{strategy}</span>
        </div>
        <div className="text-right"><div className="text-xs text-gray-500">Confidence</div><div className="text-xl font-bold text-white">{analysis.confidence_score}%</div></div>
      </div>

      {/* Grade Card */}
      <div className="bg-fin-panel border border-fin-border rounded-2xl p-6 mb-8 relative overflow-hidden">
        <div className="flex flex-col lg:flex-row gap-8 items-center lg:items-start">
          <div className={`flex flex-col items-center justify-center w-32 h-32 rounded-2xl border-2 ${grading.grade.includes('A') ? 'border-fin-bull text-fin-bull bg-fin-bull/10' : grading.grade.includes('B') ? 'border-orange-500 text-orange-500 bg-orange-500/10' : 'border-fin-bear text-fin-bear bg-fin-bear/10'}`}>
            <span className="text-6xl font-bold font-mono">{grading.grade}</span>
          </div>
          <div className="flex-grow space-y-4">
            <h2 className="text-2xl font-bold text-white">{grading.headline}</h2>
            <p className="text-gray-400">{grading.reasoning}</p>
            <div className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold border ${grading.grade.includes("A") ? "text-fin-bull border-fin-bull/30 bg-fin-bull/10" : "text-fin-bear border-fin-bear/30 bg-fin-bear/10"}`}>
              {grading.grade.includes("A") ? <CheckCircle2 className="w-4 h-4" /> : <AlertTriangle className="w-4 h-4" />}
              {grading.grade.includes("A") ? "APPROVED: Standard Risk" : "HIGH RISK: Paper Trade Only"}
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* Left Column */}
        <div className="lg:col-span-7 space-y-6">
          <div className="rounded-xl overflow-hidden border border-fin-border bg-black min-h-[300px] flex items-center justify-center">
            {imagePreview ? <img src={imagePreview} className="w-full opacity-90" /> : <div className="text-gray-500 flex flex-col items-center"><ImageOff className="w-10 h-10 mb-2" />Chart Not Archived</div>}
          </div>
          <div className="bg-fin-panel border border-fin-border rounded-xl p-6">
            <h3 className="flex items-center gap-2 text-lg font-bold text-gray-200 mb-4"><FileText className="w-5 h-5 text-fin-accent" /> Visual Intelligence</h3>
            <p className="text-gray-300 font-light">{analysis.visual_findings || visual_analysis.patterns_detected.join(", ")}</p>
          </div>
          <div className="bg-fin-panel border border-fin-border rounded-xl p-6">
            <h3 className="flex items-center gap-2 text-lg font-bold text-gray-200 mb-4"><Globe className="w-5 h-5 text-blue-400" /> Market Grounding</h3>
            <p className="text-gray-300 font-light mb-4">{analysis.grounding_findings}</p>
            {external_data?.sources?.map((s, i) => (
              <a key={i} href={s.uri} target="_blank" className="block text-xs text-fin-accent hover:underline mb-1 flex items-center gap-1"><ExternalLink className="w-3 h-3" /> {s.title}</a>
            ))}
          </div>
        </div>

        {/* Right Column */}
        <div className="lg:col-span-5 space-y-6">
          <div className="bg-fin-panel border border-fin-border rounded-xl p-6 flex flex-col items-center">
            <h3 className="text-gray-400 font-bold mb-6 text-xs tracking-wider flex items-center gap-2"><Activity className="w-4 h-4 text-fin-accent" /> TRADE DNA</h3>
            <RadarChart visual={grading.visual_score} data={grading.data_score} sentiment={grading.sentiment_score} risk={grading.risk_reward_score} momentum={grading.momentum_score} />
          </div>
          <div className={`bg-fin-panel border rounded-xl overflow-hidden shadow-lg ${!isTradeable ? 'border-fin-bear/30' : 'border-fin-border'}`}>
            {!isTradeable && <div className="bg-fin-bear/10 px-6 py-2 text-fin-bear text-xs font-bold text-center">HIGH RISK</div>}
            <div className="bg-fin-border/30 px-6 py-4 flex justify-between items-center"><span className="font-mono font-bold text-gray-200">EXECUTION</span><span className={`text-xs font-bold px-2 py-0.5 rounded ${trade_plan.bias === 'LONG' ? 'bg-fin-bull/20 text-fin-bull' : 'bg-fin-bear/20 text-fin-bear'}`}>{trade_plan.bias}</span></div>
            <div className="p-6 space-y-6">
              <div className="border-l-2 border-blue-500 pl-4"><div className="text-xs text-gray-500 font-bold">ENTRY</div><div className="text-xl font-mono text-white font-bold">{trade_plan.entry_zone}</div></div>
              <div className="border-l-2 border-fin-bear pl-4"><div className="text-xs text-gray-500 font-bold">STOP</div><div className="text-xl font-mono text-white font-bold">{trade_plan.stop_loss}</div></div>
              <div className="border-l-2 border-fin-bull pl-4"><div className="text-xs text-gray-500 font-bold">TARGET</div><div className="text-xl font-mono text-white font-bold">{trade_plan.take_profit_1}</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
EOF

# ReportsView.tsx
cat << 'EOF' > src/components/ReportsView.tsx
import React from 'react';
import { Report } from '../types';
import { FileText, Trash2, Eye, Calendar, TrendingUp, TrendingDown, Minus } from 'lucide-react';

interface Props { history: Report[]; onView: (r: Report) => void; onDelete: (id: string) => void; }

export const ReportsView: React.FC<Props> = ({ history, onView, onDelete }) => {
  if (history.length === 0) return <div className="text-center py-20"><div className="text-gray-500">No Reports Found</div></div>;

  return (
    <div className="max-w-7xl mx-auto space-y-8 animate-fade-in">
      <h1 className="text-3xl font-bold text-white font-mono">Analysis History</h1>
      <div className="bg-fin-panel border border-fin-border rounded-2xl overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-fin-card text-xs text-gray-400 font-bold"><tr className="border-b border-fin-border"><th className="px-6 py-4">Ticker</th><th className="px-6 py-4">Grade</th><th className="px-6 py-4">Bias</th><th className="px-6 py-4">Date</th><th className="px-6 py-4 text-right">Actions</th></tr></thead>
          <tbody className="divide-y divide-fin-border">
            {history.map(r => (
              <tr key={r.id} className="hover:bg-fin-card/50">
                <td className="px-6 py-4 font-bold text-white">{r.ticker} <span className="text-gray-500 text-xs font-normal ml-2">{r.strategy}</span></td>
                <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs font-bold ${r.grade.includes('A') ? 'bg-fin-bull/20 text-fin-bull' : 'bg-gray-700 text-gray-300'}`}>{r.grade}</span></td>
                <td className="px-6 py-4"><span className={`flex items-center gap-1 text-xs font-bold ${r.bias === 'LONG' ? 'text-fin-bull' : 'text-fin-bear'}`}>{r.bias === 'LONG' ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}{r.bias}</span></td>
                <td className="px-6 py-4 text-sm text-gray-400">{new Date(r.timestamp).toLocaleDateString()}</td>
                <td className="px-6 py-4 text-right flex justify-end gap-2">
                  <button onClick={() => onView(r)} className="p-2 hover:bg-fin-border rounded"><Eye className="w-4 h-4 text-gray-400" /></button>
                  <button onClick={() => onDelete(r.id)} className="p-2 hover:bg-fin-bear/10 rounded"><Trash2 className="w-4 h-4 text-fin-bear" /></button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};
EOF

# FileUpload.tsx
cat << 'EOF' > src/components/FileUpload.tsx
import React, { useRef } from 'react';
import { UploadCloud } from 'lucide-react';
interface Props { onFileSelect: (f: File) => void; }
export const FileUpload: React.FC<Props> = ({ onFileSelect }) => {
  const inputRef = useRef<HTMLInputElement>(null);
  return (
    <div className="w-full max-w-2xl h-64 border-2 border-dashed border-fin-border rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-fin-accent hover:bg-fin-panel transition-all" onClick={() => inputRef.current?.click()} onDragOver={e => e.preventDefault()} onDrop={e => { e.preventDefault(); if(e.dataTransfer.files[0]) onFileSelect(e.dataTransfer.files[0]); }}>
      <input type="file" ref={inputRef} onChange={e => e.target.files?.[0] && onFileSelect(e.target.files[0])} accept="image/*" className="hidden" />
      <UploadCloud className="w-8 h-8 text-gray-400 mb-4" />
      <h3 className="text-xl font-bold text-gray-200">Drop chart here</h3>
    </div>
  );
};
EOF

# TradingViewWidget.tsx
cat << 'EOF' > src/components/TradingViewWidget.tsx
import React, { useEffect, useRef, memo } from 'react';
export const TradingViewWidget: React.FC<{ symbol?: string }> = memo(({ symbol = "NASDAQ:AAPL" }) => {
  const container = useRef<HTMLDivElement>(null);
  useEffect(() => {
    if (!container.current) return;
    container.current.innerHTML = "";
    const script = document.createElement("script");
    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
    script.async = true;
    script.innerHTML = JSON.stringify({ "autosize": true, "symbol": symbol, "interval": "D", "theme": "dark", "style": "1", "hide_top_toolbar": false, "hide_legend": false, "save_image": false, "hide_volume": true });
    container.current.appendChild(script);
  }, [symbol]);
  return <div className="h-[400px] w-full bg-fin-panel border border-fin-border rounded-2xl overflow-hidden shadow-lg" ref={container}><div className="tradingview-widget-container__widget h-full w-full"></div></div>;
});
EOF

# --- App.tsx ---
cat << 'EOF' > src/App.tsx
import React, { useState, useEffect } from 'react';
import { StrategyType, AppState, Report } from './types';
import { validateChart, analyzeChart } from './services/geminiService';
import { StrategySelector } from './components/StrategySelector';
import { FileUpload } from './components/FileUpload';
import { AnalysisView } from './components/AnalysisView';
import { ReportsView } from './components/ReportsView';
import { TradingViewWidget } from './components/TradingViewWidget';
import { Activity, LayoutDashboard, History, AlertCircle, Loader2, ArrowLeft, Terminal, Camera, Zap, BookOpen } from 'lucide-react';

const App: React.FC = () => {
  const [history, setHistory] = useState<Report[]>(() => JSON.parse(localStorage.getItem('analysis_history') || "[]"));
  const [activeTicker, setActiveTicker] = useState("NASDAQ:AAPL");
  const [captureError, setCaptureError] = useState<string | null>(null);
  const [state, setState] = useState<Omit<AppState, 'history'>>({ step: 'UPLOAD', selectedStrategy: StrategyType.SMC, imageFile: null, imagePreviewUrl: null, validationData: null, analysisData: null, error: null, logs: [] });

  useEffect(() => localStorage.setItem('analysis_history', JSON.stringify(history)), [history]);
  
  const handleFileSelect = async (file: File) => {
    const url = URL.createObjectURL(file);
    setState(p => ({ ...p, imageFile: file, imagePreviewUrl: url, step: 'VALIDATING', error: null, logs: ["Validating..."] }));
    try {
      const val = await validateChart(file);
      if (!val.is_valid_chart) throw new Error(val.rejection_reason || "Invalid Chart");
      setState(p => ({ ...p, validationData: val, step: 'ANALYZING', logs: [...p.logs, "Running Strategy..."] }));
      const analysis = await analyzeChart(file, state.selectedStrategy, val.metadata);
      setHistory(prev => [{ id: Date.now().toString(), timestamp: Date.now(), ticker: val.metadata?.ticker || "UNK", strategy: state.selectedStrategy, grade: analysis.grading.grade, bias: analysis.trade_plan.bias, data: analysis, validation: val }, ...prev].slice(0, 10));
      setState(p => ({ ...p, analysisData: analysis, step: 'RESULTS' }));
    } catch (e: any) { setState(p => ({ ...p, step: 'ERROR', error: e.message })); }
  };

  const captureActiveChart = async () => {
    setCaptureError(null);
    try {
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: { displaySurface: "browser" }, audio: false });
      const video = document.createElement("video"); video.muted = true; video.autoplay = true; video.srcObject = stream; document.body.appendChild(video); await video.play();
      const track = stream.getVideoTracks()[0];
      const bitmap = await new (window as any).ImageCapture(track).grabFrame();
      const canvas = document.createElement("canvas"); canvas.width = bitmap.width; canvas.height = bitmap.height;
      canvas.getContext("2d")?.drawImage(bitmap, 0, 0);
      canvas.toBlob(b => b && handleFileSelect(new File([b], "scan.png", { type: "image/png" })), "image/png");
      track.stop(); document.body.removeChild(video);
    } catch (e: any) {
      if (e.name === 'SecurityError' || e.message.includes('permission')) setCaptureError("Browser blocked capture. Use Manual Upload.");
    }
  };

  return (
    <div className="min-h-screen bg-black text-gray-200 font-sans flex">
      <aside className="w-64 bg-fin-panel border-r border-fin-border hidden lg:flex flex-col p-4">
        <div className="flex items-center gap-3 mb-8 px-2"><Activity className="text-fin-accent" /><h1 className="font-bold">QUANTICAST</h1></div>
        <nav className="space-y-1">
          <button onClick={() => setState(p => ({ ...p, step: 'UPLOAD' }))} className={`w-full flex gap-3 px-4 py-3 rounded ${state.step !== 'REPORTS' ? 'bg-fin-accent text-white' : 'text-gray-400'}`}><LayoutDashboard className="w-5 h-5" /> Dashboard</button>
          <button onClick={() => setState(p => ({ ...p, step: 'REPORTS' }))} className={`w-full flex gap-3 px-4 py-3 rounded ${state.step === 'REPORTS' ? 'bg-fin-accent text-white' : 'text-gray-400'}`}><History className="w-5 h-5" /> Reports</button>
        </nav>
      </aside>
      <main className="flex-1 p-8 overflow-y-auto">
        <header className="flex justify-between mb-8">
          <input type="text" placeholder="Search ticker..." className="bg-fin-dark border border-fin-border rounded px-4 py-2 w-64" onKeyDown={e => e.key === 'Enter' && setActiveTicker(e.currentTarget.value.toUpperCase())} />
          <button onClick={() => window.open('/DOCUMENTATION.md', '_blank')} className="flex items-center gap-2 text-gray-400 hover:text-white"><BookOpen className="w-4 h-4" /> Documentation</button>
        </header>
        {state.step === 'REPORTS' ? <ReportsView history={history} onView={r => setState(p => ({ ...p, step: 'RESULTS', analysisData: r.data, validationData: r.validation, imagePreviewUrl: null }))} onDelete={id => setHistory(h => h.filter(x => x.id !== id))} /> :
         state.step === 'RESULTS' && state.analysisData ? <div className="max-w-7xl mx-auto"><button onClick={() => setState(p => ({ ...p, step: 'UPLOAD' }))} className="mb-4 flex gap-2 text-gray-400"><ArrowLeft /> Back</button><AnalysisView validation={state.validationData!} analysis={state.analysisData} imagePreview={state.imagePreviewUrl} strategy={state.selectedStrategy} /></div> :
         state.step === 'VALIDATING' || state.step === 'ANALYZING' ? <div className="text-center mt-20"><Loader2 className="w-16 h-16 text-fin-accent animate-spin mx-auto mb-4" /><h2 className="text-2xl font-bold">Analyzing...</h2><div className="text-gray-500 mt-2 font-mono text-sm">{state.logs.slice(-1)}</div></div> :
         state.step === 'ERROR' ? <div className="text-center mt-20"><AlertCircle className="w-16 h-16 text-fin-bear mx-auto mb-4" /><h2 className="text-2xl font-bold">Analysis Failed</h2><p className="text-gray-500 mb-6">{state.error}</p><button onClick={() => setState(p => ({ ...p, step: 'UPLOAD', error: null }))} className="bg-white text-black px-6 py-2 rounded font-bold">Try Again</button></div> :
         <div className="max-w-7xl mx-auto space-y-8">
           <div><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold flex gap-2"><Activity className="text-fin-accent" /> Market Context</h2><div className="flex gap-4">{captureError && <span className="text-fin-bear text-sm font-bold animate-pulse">{captureError}</span>}<button onClick={captureActiveChart} className="bg-fin-accent px-4 py-2 rounded font-bold flex gap-2"><Camera className="w-4 h-4" /> Scan Active Chart</button></div></div><TradingViewWidget symbol={activeTicker} /></div>
           <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
             <div className="xl:col-span-2 space-y-8"><div className="bg-fin-card border border-fin-border rounded-2xl p-6"><h3 className="font-bold mb-6 flex gap-2"><Terminal className="text-gray-400" /> 1. Select Framework</h3><StrategySelector selected={state.selectedStrategy} onSelect={s => setState(p => ({ ...p, selectedStrategy: s }))} /></div><div id="manual-upload" className="bg-fin-card border border-fin-border rounded-2xl p-6"><h3 className="font-bold mb-6 flex gap-2"><Camera className="text-gray-400" /> 2. Manual Upload</h3><FileUpload onFileSelect={handleFileSelect} /></div></div>
             <div className="bg-fin-card border border-fin-border rounded-2xl p-6"><h3 className="font-bold mb-4">Recent Reports</h3>{history.slice(0, 3).map(r => <div key={r.id} onClick={() => setState(p => ({ ...p, step: 'RESULTS', analysisData: r.data, validationData: r.validation }))} className="p-3 mb-2 bg-fin-dark border border-fin-border rounded cursor-pointer hover:border-fin-accent flex justify-between"><div><div className="font-bold">{r.ticker}</div><div className="text-xs text-gray-500">{r.strategy}</div></div><span className={`text-xs font-bold px-2 py-1 rounded h-fit ${r.grade.includes('A') ? 'bg-fin-bull/20 text-fin-bull' : 'bg-gray-700'}`}>{r.grade}</span></div>)}</div>
           </div>
         </div>}
      </main>
    </div>
  );
};
export default App;
EOF

# --- main.tsx ---
cat << 'EOF' > src/main.tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
EOF

# --- index.css ---
cat << 'EOF' > src/index.css
@tailwind base;
@tailwind components;
@tailwind utilities;
EOF

# --- DOCUMENTATION ---
cat << 'EOF' > DOCUMENTATION.md
# QUANTICAST AI - Developer Documentation

## 1. Executive Summary
**QUANTICAST** is a "Cognitive Hedge Fund" application designed to democratize institutional-grade market analysis.

## 2. Key Achievements & Features
*   **Hybrid Intelligence Architecture**: Vision Engine (Gemini 2.5 Flash) + Search Agent (Macro Grounding).
*   **Professional Dashboard UI**: Dark-mode, TradingView Integration, History Management.
*   **Advanced Strategy Library**: SMC, Liquidity Flow, VCP, Macro, Quant.

## 3. Current Challenges
*   **Screen Capture API**: `getDisplayMedia` is restricted in iframe environments (StackBlitz, Bolt). Fallback to manual upload implemented.

## 4. Roadmap
*   **Tier System**: Free vs Pro logic.
*   **"Event Horizon"**: Deepening forward-looking risk.
EOF

# --- README & CHANGELOG ---
cat << 'EOF' > README.md
# QUANTICAST AI: The Cognitive Hedge Fund
![v1.2.0](https://img.shields.io/badge/version-1.2.0-blue)
Professional AI Portfolio Manager using Computer Vision & Agentic Search.

## Features
- **Hybrid Intelligence**: Chart Vision + Macro Search.
- **Institutional Grading**: A+ to C Risk Matrix.
- **Real-Time Context**: TradingView Charts + Screen Scanning.
- **13 Strategies**: From Day Trading (SMC) to Macro Forecasting.

## Roadmap
- [x] v1.2: Liquidity Strategy, Relaxed Grading.
- [ ] v1.3: "Event Horizon" Layer.
EOF

cat << 'EOF' > CHANGELOG.md
# Changelog
## [v1.2.0]
- Added Liquidity & Order Flow Strategy.
- Relaxed Grading Logic (Grade C = High Risk, not Rejected).
- Added Documentation.
EOF

echo "‚úÖ Setup Complete! Run 'npm run dev' to start."
