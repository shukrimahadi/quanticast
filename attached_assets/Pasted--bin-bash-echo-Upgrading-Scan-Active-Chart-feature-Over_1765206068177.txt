#!/bin/bash

echo "ðŸ“¸ Upgrading 'Scan Active Chart' feature..."

# Overwrite App.tsx with the improved capture logic (Canvas-based instead of ImageCapture)
cat << 'EOF' > src/App.tsx
import React, { useState, useEffect } from 'react';
import { StrategyType, AppState, ValidationResponse, FinalAnalysis, Report } from './types';
import { validateChart, analyzeChart } from './services/geminiService';
import { StrategySelector } from './components/StrategySelector';
import { FileUpload } from './components/FileUpload';
import { AnalysisView } from './components/AnalysisView';
import { ReportsView } from './components/ReportsView';
import { TradingViewWidget } from './components/TradingViewWidget';
import { Activity, LayoutDashboard, History, AlertCircle, Loader2, ArrowLeft, Terminal, Camera, Zap, XCircle, BookOpen } from 'lucide-react';

const App: React.FC = () => {
  const [history, setHistory] = useState<Report[]>(() => {
    const saved = localStorage.getItem('analysis_history');
    return saved ? JSON.parse(saved) : [];
  });

  const [activeTicker, setActiveTicker] = useState("NASDAQ:AAPL");
  const [captureError, setCaptureError] = useState<string | null>(null);

  const [state, setState] = useState<Omit<AppState, 'history'>>({
    step: 'UPLOAD',
    selectedStrategy: StrategyType.SMC,
    imageFile: null,
    imagePreviewUrl: null,
    validationData: null,
    analysisData: null,
    error: null,
    logs: [],
  });

  useEffect(() => {
    localStorage.setItem('analysis_history', JSON.stringify(history));
  }, [history]);

  const addLog = (msg: string) => {
    setState(prev => ({ ...prev, logs: [...prev.logs, `[${new Date().toLocaleTimeString()}] ${msg}`] }));
  };

  const handleStrategySelect = (strategy: StrategyType) => {
    setState(prev => ({ ...prev, selectedStrategy: strategy }));
  };

  const handleFileSelect = async (file: File) => {
    const url = URL.createObjectURL(file);
    setState(prev => ({
      ...prev,
      imageFile: file,
      imagePreviewUrl: url,
      step: 'VALIDATING',
      error: null,
      logs: [`Starting analysis...`]
    }));

    try {
      addLog("Validating chart image...");
      const validation = await validateChart(file);

      if (!validation.is_valid_chart) {
        throw new Error(validation.rejection_reason || "Invalid chart image.");
      }

      addLog(`Chart Validated: ${validation.metadata?.ticker} (${validation.metadata?.timeframe})`);
      setState(prev => ({ ...prev, validationData: validation, step: 'ANALYZING' }));

      addLog(`Running ${state.selectedStrategy} analysis strategy...`);
      const analysis = await analyzeChart(file, state.selectedStrategy, validation.metadata);

      const newReport: Report = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        ticker: validation.metadata?.ticker || "UNKNOWN",
        strategy: state.selectedStrategy,
        grade: analysis.grading.grade,
        bias: analysis.trade_plan.bias,
        data: analysis,
        validation: validation
      };

      setHistory(prev => [newReport, ...prev].slice(0, 10));
      setState(prev => ({
        ...prev,
        analysisData: analysis,
        step: 'RESULTS'
      }));
      addLog("Analysis complete.");

    } catch (error: any) {
      console.error(error);
      setState(prev => ({
        ...prev,
        step: 'ERROR',
        error: error.message || "An unknown error occurred."
      }));
      addLog(`Error: ${error.message}`);
    }
  };

  const handleReset = () => {
    if (state.imagePreviewUrl) URL.revokeObjectURL(state.imagePreviewUrl);
    setState(prev => ({
      step: 'UPLOAD',
      selectedStrategy: prev.selectedStrategy,
      imageFile: null,
      imagePreviewUrl: null,
      validationData: null,
      analysisData: null,
      error: null,
      logs: []
    }));
  };

  const handleDeleteReport = (id: string) => {
    setHistory(prev => prev.filter(r => r.id !== id));
  };

  const handleViewReport = (report: Report) => {
    setState(prev => ({
      ...prev,
      step: 'RESULTS',
      validationData: report.validation,
      analysisData: report.data,
      selectedStrategy: report.strategy,
      imagePreviewUrl: null,
      error: null
    }));
  };

  const navigateToHistory = () => {
    setState(prev => ({ ...prev, step: 'REPORTS', error: null }));
  };

  const navigateToUpload = () => {
    if (state.step === 'REPORTS') {
       if (state.imagePreviewUrl) URL.revokeObjectURL(state.imagePreviewUrl);
       setState(prev => ({
        ...prev,
        step: 'UPLOAD',
        imageFile: null,
        imagePreviewUrl: null,
        validationData: null,
        analysisData: null,
        logs: []
      }));
    } else {
      handleReset();
    }
  };

  const handleSearch = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      const val = e.currentTarget.value.trim().toUpperCase();
      if (val) setActiveTicker(val);
    }
  };

  const processFile = (file: File) => {
    handleFileSelect(file);
  };

  const captureActiveChart = async () => {
    setCaptureError(null);
    try {
      // 1. Request Screen Share
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: {
          displaySurface: "browser",
        },
        audio: false,
      });

      // 2. Create hidden video element to play the stream
      const video = document.createElement("video");
      video.style.display = "none";
      video.muted = true;
      video.autoplay = true;
      video.playsInline = true;
      video.srcObject = stream;
      
      // Critical: Attach to DOM to ensure playback in some environments
      document.body.appendChild(video);
      
      await video.play();

      // 3. Wait for video to have dimensions
      await new Promise((resolve) => setTimeout(resolve, 500));

      // 4. Draw video frame to canvas (Universal compatibility)
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      
      if (ctx) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
          if (blob) {
            const file = new File([blob], "chart_scan.png", { type: "image/png" });
            processFile(file);
          }
        }, "image/png");
      }

      // 5. Cleanup
      track.stop();
      stream.getTracks().forEach(t => t.stop());
      video.pause();
      video.srcObject = null;
      if (document.body.contains(video)) {
        document.body.removeChild(video);
      }
      // Re-declare track for scoping consistency above or rely on stream cleanup
      const track = stream.getVideoTracks()[0];
      track.stop();

    } catch (err: any) {
      console.error("Capture failed:", err);
      // If user cancelled, just ignore.
      if (err.name === 'NotAllowedError') {
         console.log("User cancelled capture.");
         return;
      }
      
      // Permission Policy Error (common in iframes/StackBlitz/Replit)
      if (err.name === 'SecurityError' || err.message.includes('permissions policy')) {
         setCaptureError("Browser security blocked direct capture. Please take a screenshot manually and drag it below.");
         // Scroll to manual upload
         const uploadSection = document.getElementById('manual-upload');
         if (uploadSection) {
             uploadSection.scrollIntoView({ behavior: 'smooth' });
             uploadSection.classList.add('ring-2', 'ring-fin-accent');
             setTimeout(() => uploadSection.classList.remove('ring-2', 'ring-fin-accent'), 2000);
         }
         return;
      }

      setCaptureError("Screen capture failed. Please upload manually.");
    }
  };

  return (
    <div className="min-h-screen bg-black text-gray-200 font-sans selection:bg-fin-accent/30 selection:text-fin-accent">
      <aside className="fixed top-0 left-0 h-full w-64 bg-fin-panel border-r border-fin-border hidden lg:flex flex-col z-50">
         <div className="p-6 border-b border-fin-border flex items-center gap-3">
            <Activity className="w-8 h-8 text-fin-accent" />
            <div>
               <h1 className="text-xl font-bold text-white tracking-tight">QUANTICAST</h1>
            </div>
         </div>
         <div className="p-4 space-y-1">
            <div className="text-xs font-bold text-gray-500 uppercase px-4 mb-2 tracking-widest">Main Menu</div>
            <button onClick={navigateToUpload} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${state.step !== 'REPORTS' ? 'bg-fin-accent text-white shadow-[0_0_20px_rgba(59,130,246,0.3)]' : 'text-gray-400 hover:bg-fin-card hover:text-white'}`}>
              <LayoutDashboard className="w-5 h-5" /> Dashboard
            </button>
            <button onClick={navigateToHistory} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${state.step === 'REPORTS' ? 'bg-fin-accent text-white shadow-[0_0_20px_rgba(59,130,246,0.3)]' : 'text-gray-400 hover:bg-fin-card hover:text-white'}`}>
              <History className="w-5 h-5" /> Reports
            </button>
         </div>
         <div className="mt-auto p-4 border-t border-fin-border">
            <div className="flex items-center gap-3 px-2">
               <div className="w-10 h-10 rounded-full bg-fin-accent/20 flex items-center justify-center text-fin-accent font-bold">PM</div>
               <div>
                  <div className="text-sm font-bold text-white">Portfolio Manager</div>
                  <div className="text-xs text-gray-500">Super Admin</div>
               </div>
            </div>
         </div>
      </aside>

      <div className="lg:ml-64 min-h-screen flex flex-col">
        <header className="h-16 border-b border-fin-border bg-fin-panel/50 backdrop-blur-md sticky top-0 z-40 px-8 flex items-center justify-between">
           <div className="flex-1 max-w-md">
              <input type="text" placeholder="Search ticker to update chart (Press Enter)..." className="w-full bg-fin-dark border border-fin-border rounded-lg px-4 py-2 text-sm text-gray-200 focus:outline-none focus:border-fin-accent transition-colors" onKeyDown={handleSearch} />
           </div>
           <div className="flex items-center gap-4">
              <button onClick={() => window.open('/DOCUMENTATION.md', '_blank')} className="flex items-center gap-2 px-3 py-1.5 text-gray-400 hover:text-white hover:bg-fin-border rounded-lg transition-colors text-sm font-medium">
                <BookOpen className="w-4 h-4" /> Documentation
              </button>
           </div>
        </header>

        <main className="flex-1 p-8 overflow-y-auto">
          {state.step === 'REPORTS' && <ReportsView history={history} onView={handleViewReport} onDelete={handleDeleteReport} />}

          {(state.step === 'UPLOAD') && (
            <div className="max-w-7xl mx-auto space-y-8 animate-fade-in">
              <div className="space-y-4">
                 <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold text-white flex items-center gap-3"><Activity className="w-6 h-6 text-fin-accent" /> Market Context</h2>
                    <div className="flex items-center gap-4">
                       {captureError && <span className="text-xs text-fin-bear font-bold bg-fin-bear/10 px-3 py-1 rounded-full animate-pulse">{captureError}</span>}
                       <button onClick={captureActiveChart} className="flex items-center gap-2 px-4 py-2 bg-fin-accent hover:bg-blue-600 text-white rounded-lg font-bold text-sm transition-all shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:shadow-[0_0_25px_rgba(59,130,246,0.5)]">
                         <Camera className="w-4 h-4" /> Scan Active Chart
                       </button>
                    </div>
                 </div>
                 
                 <div className="rounded-2xl border border-fin-border overflow-hidden shadow-2xl bg-fin-card h-[450px]">
                    <TradingViewWidget symbol={activeTicker} />
                 </div>
              </div>

              <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                 <div className="xl:col-span-2 space-y-8">
                    <div className="bg-fin-card border border-fin-border rounded-2xl p-6">
                       <h3 className="text-lg font-bold text-gray-200 mb-6 flex items-center gap-2"><Terminal className="w-5 h-5 text-gray-400" /> 1. Select Framework</h3>
                       <StrategySelector selected={state.selectedStrategy} onSelect={handleStrategySelect} />
                    </div>
                    <div id="manual-upload" className="bg-fin-card border border-fin-border rounded-2xl p-6 transition-all duration-500">
                       <h3 className="text-lg font-bold text-gray-200 mb-6 flex items-center gap-2"><Camera className="w-5 h-5 text-gray-400" /> 2. Manual Upload (Optional)</h3>
                       <div className="flex justify-center"><FileUpload onFileSelect={handleFileSelect} /></div>
                    </div>
                 </div>

                 <div className="xl:col-span-1 space-y-6">
                    <div className="bg-fin-card border border-fin-border rounded-2xl p-6">
                       <h3 className="text-lg font-bold text-gray-200 mb-4">Recent Reports</h3>
                       <div className="space-y-3">
                          {history.slice(0, 3).map(report => (
                             <div key={report.id} onClick={() => handleViewReport(report)} className="flex items-center justify-between p-3 rounded-lg bg-fin-dark border border-fin-border hover:border-fin-accent cursor-pointer transition-all group">
                                <div className="flex items-center gap-3">
                                   <div className={`w-8 h-8 rounded flex items-center justify-center font-bold text-xs ${report.grade.includes('A') ? 'bg-fin-bull/20 text-fin-bull' : 'bg-gray-700 text-gray-400'}`}>{report.grade}</div>
                                   <div><div className="font-bold text-white text-sm">{report.ticker}</div><div className="text-xs text-gray-500">{new Date(report.timestamp).toLocaleTimeString()}</div></div>
                                </div>
                                <span className={`text-xs font-bold px-2 py-1 rounded ${report.bias === 'LONG' ? 'bg-fin-bull/10 text-fin-bull' : 'bg-fin-bear/10 text-fin-bear'}`}>{report.bias}</span>
                             </div>
                          ))}
                          {history.length === 0 && <div className="text-center py-8 text-gray-500 text-sm">No recent activity</div>}
                       </div>
                    </div>
                 </div>
              </div>
            </div>
          )}

          {(state.step === 'VALIDATING' || state.step === 'ANALYZING') && (
             <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-fade-in">
                <div className="relative"><div className="absolute inset-0 bg-fin-accent/20 blur-xl rounded-full"></div><Loader2 className="w-20 h-20 text-fin-accent animate-spin relative z-10" /></div>
                <div><h2 className="text-3xl font-bold text-white mb-2">{state.step === 'VALIDATING' ? 'Validating Asset...' : 'Running Quant Models...'}</h2><p className="text-gray-400 max-w-md mx-auto">{state.step === 'VALIDATING' ? 'Extracting price data.' : `Applying ${state.selectedStrategy} framework.`}</p></div>
                <div className="w-full max-w-lg bg-fin-panel border border-fin-border rounded-lg p-4 font-mono text-xs text-left text-gray-400 h-48 overflow-y-auto custom-scrollbar">{state.logs.map((log, i) => <div key={i} className="mb-1">{log}</div>)}</div>
             </div>
          )}

          {state.step === 'ERROR' && (
            <div className="flex flex-col items-center justify-center min-h-[50vh] text-center animate-fade-in">
               <div className="w-20 h-20 bg-fin-bear/10 rounded-full flex items-center justify-center mb-6 border border-fin-bear/30"><AlertCircle className="w-10 h-10 text-fin-bear" /></div>
               <h2 className="text-3xl font-bold text-white mb-4">Analysis Failed</h2>
               <p className="text-gray-400 max-w-lg mb-8">{state.error}</p>
               <button onClick={handleReset} className="px-6 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2"><ArrowLeft className="w-4 h-4" /> Try Again</button>
            </div>
          )}

          {state.step === 'RESULTS' && state.analysisData && state.validationData && (
            <div className="space-y-6 max-w-7xl mx-auto">
              <button onClick={handleReset} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4"><ArrowLeft className="w-4 h-4" /> Back to Dashboard</button>
              <AnalysisView validation={state.validationData} analysis={state.analysisData} imagePreview={state.imagePreviewUrl} strategy={state.selectedStrategy} />
            </div>
          )}
        </main>
      </div>
    </div>
  );
};
export default App;
EOF

echo "âœ… Scan Feature Logic Updated."