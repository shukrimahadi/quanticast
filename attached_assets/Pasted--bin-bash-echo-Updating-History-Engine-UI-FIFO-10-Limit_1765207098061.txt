#!/bin/bash

echo "ðŸ“œ Updating History Engine & UI (FIFO 10 Limit)..."

# 1. Create the Reports View Component (The History Page)
# This component renders the table and "View/Delete" actions.
cat << 'EOF' > src/components/ReportsView.tsx
import React from 'react';
import { Report } from '../types';
import { FileText, Trash2, Eye, Calendar, TrendingUp, TrendingDown, Minus, Info } from 'lucide-react';

interface Props {
  history: Report[];
  onView: (report: Report) => void;
  onDelete: (id: string) => void;
}

export const ReportsView: React.FC<Props> = ({ history, onView, onDelete }) => {
  if (history.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-96 text-center animate-fade-in border border-dashed border-fin-border rounded-2xl bg-fin-card/30 m-8">
        <div className="w-20 h-20 bg-fin-panel rounded-full flex items-center justify-center mb-6 border border-fin-border shadow-inner">
          <FileText className="w-10 h-10 text-gray-600" />
        </div>
        <h2 className="text-2xl font-bold text-white mb-2">No Reports Archived</h2>
        <p className="text-gray-400 max-w-sm mx-auto leading-relaxed">
          Your analysis history is empty. Run a new strategy on the Dashboard to see it archived here.
        </p>
      </div>
    );
  }

  return (
    <div className="animate-fade-in space-y-8 max-w-7xl mx-auto">
      {/* Header Section */}
      <div className="flex flex-col md:flex-row md:items-end justify-between gap-4 border-b border-fin-border pb-6">
        <div>
          <h1 className="text-3xl font-bold text-white font-mono flex items-center gap-3">
            Analysis History
            <span className="text-xs bg-fin-border text-gray-400 px-2 py-1 rounded border border-gray-700 font-sans font-medium">FIFO</span>
          </h1>
          <p className="text-gray-400 mt-2 flex items-center gap-2">
            <Info className="w-4 h-4 text-fin-accent" />
            Archive of your most recent technical assessments.
          </p>
        </div>
        <div className="text-right">
          <div className="text-xs uppercase tracking-widest text-gray-500 font-bold mb-1">Storage Capacity</div>
          <div className="text-2xl font-mono text-white font-bold">
            <span className={history.length === 10 ? "text-fin-bear" : "text-fin-accent"}>{history.length}</span>
            <span className="text-gray-600 text-lg">/10</span>
          </div>
        </div>
      </div>

      {/* Table Section */}
      <div className="bg-fin-panel border border-fin-border rounded-2xl overflow-hidden shadow-2xl">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-fin-card border-b border-fin-border text-xs uppercase tracking-wider text-gray-400 font-bold">
                <th className="px-6 py-5">Ticker / Strategy</th>
                <th className="px-6 py-5 text-center">Grade</th>
                <th className="px-6 py-5 text-center">Bias</th>
                <th className="px-6 py-5">Date</th>
                <th className="px-6 py-5 text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-fin-border/50">
              {history.map((report) => (
                <tr key={report.id} className="hover:bg-fin-card/50 transition-colors group">
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 rounded-xl bg-fin-dark border border-fin-border flex items-center justify-center font-bold text-lg text-gray-500 group-hover:border-fin-accent group-hover:text-fin-accent transition-all shadow-sm">
                        {report.ticker.charAt(0)}
                      </div>
                      <div>
                        <div className="font-bold text-white text-base">{report.ticker}</div>
                        <div className="text-xs text-gray-500 font-mono mt-0.5">{report.strategy}</div>
                      </div>
                    </div>
                  </td>
                  
                  <td className="px-6 py-4 text-center">
                     <span className={`inline-flex items-center justify-center w-10 h-10 rounded-lg font-bold text-sm shadow-lg ${
                        report.grade.includes('A') ? 'bg-fin-bull/10 text-fin-bull border border-fin-bull/20' : 
                        report.grade.includes('B') ? 'bg-orange-500/10 text-orange-500 border border-orange-500/20' : 
                        'bg-fin-bear/10 text-fin-bear border border-fin-bear/20'
                     }`}>
                        {report.grade}
                     </span>
                  </td>

                  <td className="px-6 py-4 text-center">
                    <div className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold border ${
                      report.bias === 'LONG' ? 'bg-fin-bull/5 text-fin-bull border-fin-bull/20' : 
                      report.bias === 'SHORT' ? 'bg-fin-bear/5 text-fin-bear border-fin-bear/20' : 
                      'bg-gray-800 text-gray-400 border-gray-700'
                    }`}>
                      {report.bias === 'LONG' && <TrendingUp className="w-3 h-3" />}
                      {report.bias === 'SHORT' && <TrendingDown className="w-3 h-3" />}
                      {report.bias !== 'LONG' && report.bias !== 'SHORT' && <Minus className="w-3 h-3" />}
                      {report.bias}
                    </div>
                  </td>

                  <td className="px-6 py-4">
                    <div className="flex flex-col text-sm">
                      <span className="text-gray-300 font-medium">{new Date(report.timestamp).toLocaleDateString()}</span>
                      <span className="text-gray-600 text-xs font-mono">{new Date(report.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                  </td>

                  <td className="px-6 py-4 text-right">
                    <div className="flex items-center justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                      <button 
                        onClick={() => onView(report)}
                        className="p-2 text-gray-400 hover:text-white hover:bg-fin-accent/20 rounded-lg transition-colors"
                        title="View Report"
                      >
                        <Eye className="w-5 h-5" />
                      </button>
                      <button 
                        onClick={() => onDelete(report.id)}
                        className="p-2 text-gray-400 hover:text-fin-bear hover:bg-fin-bear/10 rounded-lg transition-colors"
                        title="Delete from History"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};
EOF

# 2. Update App.tsx logic to enforce FIFO (Slice 0-10)
cat << 'EOF' > src/App.tsx
import React, { useState, useEffect } from 'react';
import { StrategyType, AppState, ValidationResponse, FinalAnalysis, Report } from './types';
import { validateChart, analyzeChart } from './services/geminiService';
import { StrategySelector } from './components/StrategySelector';
import { FileUpload } from './components/FileUpload';
import { AnalysisView } from './components/AnalysisView';
import { ReportsView } from './components/ReportsView';
import { TradingViewWidget } from './components/TradingViewWidget';
import { TradingViewNews } from './components/TradingViewNews';
import { Activity, LayoutDashboard, History, AlertCircle, Loader2, ArrowLeft, Terminal, Camera, Zap, XCircle, BookOpen, Newspaper } from 'lucide-react';

const App: React.FC = () => {
  // Load History from LocalStorage on mount
  const [history, setHistory] = useState<Report[]>(() => {
    const saved = localStorage.getItem('analysis_history');
    return saved ? JSON.parse(saved) : [];
  });

  const [activeTicker, setActiveTicker] = useState("NASDAQ:AAPL");
  const [captureError, setCaptureError] = useState<string | null>(null);

  const [state, setState] = useState<Omit<AppState, 'history'>>({
    step: 'UPLOAD',
    selectedStrategy: StrategyType.SMC,
    imageFile: null,
    imagePreviewUrl: null,
    validationData: null,
    analysisData: null,
    error: null,
    logs: [],
  });

  // Save History to LocalStorage whenever it changes
  useEffect(() => {
    localStorage.setItem('analysis_history', JSON.stringify(history));
  }, [history]);

  const addLog = (msg: string) => {
    setState(prev => ({ ...prev, logs: [...prev.logs, `[${new Date().toLocaleTimeString()}] ${msg}`] }));
  };

  const handleStrategySelect = (strategy: StrategyType) => {
    setState(prev => ({ ...prev, selectedStrategy: strategy }));
  };

  const handleFileSelect = async (file: File) => {
    const url = URL.createObjectURL(file);
    setState(prev => ({
      ...prev,
      imageFile: file,
      imagePreviewUrl: url,
      step: 'VALIDATING',
      error: null,
      logs: [`Starting analysis...`]
    }));

    try {
      addLog("Validating chart image...");
      const validation = await validateChart(file);

      if (!validation.is_valid_chart) {
        throw new Error(validation.rejection_reason || "Invalid chart image.");
      }

      addLog(`Chart Validated: ${validation.metadata?.ticker} (${validation.metadata?.timeframe})`);
      setState(prev => ({ ...prev, validationData: validation, step: 'ANALYZING' }));

      addLog(`Running ${state.selectedStrategy} analysis strategy...`);
      const analysis = await analyzeChart(file, state.selectedStrategy, validation.metadata);

      // Create Report Object
      const newReport: Report = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        ticker: validation.metadata?.ticker || "UNKNOWN",
        strategy: state.selectedStrategy,
        grade: analysis.grading.grade,
        bias: analysis.trade_plan.bias,
        data: analysis,
        validation: validation
      };

      // --- FIFO LOGIC: Add new report to top, keep only last 10 ---
      setHistory(prev => [newReport, ...prev].slice(0, 10));
      
      setState(prev => ({
        ...prev,
        analysisData: analysis,
        step: 'RESULTS'
      }));
      addLog("Analysis complete.");

    } catch (error: any) {
      console.error(error);
      setState(prev => ({
        ...prev,
        step: 'ERROR',
        error: error.message || "An unknown error occurred."
      }));
      addLog(`Error: ${error.message}`);
    }
  };

  const handleReset = () => {
    if (state.imagePreviewUrl) URL.revokeObjectURL(state.imagePreviewUrl);
    setState(prev => ({
      step: 'UPLOAD',
      selectedStrategy: prev.selectedStrategy,
      imageFile: null,
      imagePreviewUrl: null,
      validationData: null,
      analysisData: null,
      error: null,
      logs: []
    }));
  };

  const handleDeleteReport = (id: string) => {
    setHistory(prev => prev.filter(r => r.id !== id));
  };

  const handleViewReport = (report: Report) => {
    setState(prev => ({
      ...prev,
      step: 'RESULTS',
      validationData: report.validation,
      analysisData: report.data,
      selectedStrategy: report.strategy,
      imagePreviewUrl: null,
      error: null
    }));
  };

  const navigateToHistory = () => {
    setState(prev => ({ ...prev, step: 'REPORTS', error: null }));
  };

  const navigateToUpload = () => {
    if (state.step === 'REPORTS') {
       if (state.imagePreviewUrl) URL.revokeObjectURL(state.imagePreviewUrl);
       setState(prev => ({
        ...prev,
        step: 'UPLOAD',
        imageFile: null,
        imagePreviewUrl: null,
        validationData: null,
        analysisData: null,
        logs: []
      }));
    } else {
      handleReset();
    }
  };

  const handleSearch = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      const val = e.currentTarget.value.trim().toUpperCase();
      if (val) setActiveTicker(val);
    }
  };

  const processFile = (file: File) => {
    handleFileSelect(file);
  };

  const captureActiveChart = async () => {
    setCaptureError(null);
    try {
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: { displaySurface: "browser" },
        audio: false,
      });

      const video = document.createElement("video");
      video.style.display = "none";
      video.muted = true;
      video.autoplay = true;
      video.playsInline = true;
      video.srcObject = stream;
      document.body.appendChild(video);
      await video.play();

      await new Promise((resolve) => setTimeout(resolve, 500));

      const track = stream.getVideoTracks()[0];
      const imageCapture = new (window as any).ImageCapture(track);
      const bitmap = await imageCapture.grabFrame();

      const canvas = document.createElement("canvas");
      canvas.width = bitmap.width;
      canvas.height = bitmap.height;
      const ctx = canvas.getContext("2d");
      if (ctx) {
        ctx.drawImage(bitmap, 0, 0);
        canvas.toBlob((blob) => {
          if (blob) {
            const file = new File([blob], "chart_scan.png", { type: "image/png" });
            processFile(file);
          }
        }, "image/png");
      }

      track.stop();
      stream.getTracks().forEach(t => t.stop());
      video.pause();
      video.srcObject = null;
      if (document.body.contains(video)) {
        document.body.removeChild(video);
      }

    } catch (err: any) {
      console.error("Capture failed:", err);
      if (err.name === 'NotAllowedError') return;
      if (err.name === 'SecurityError' || err.message.includes('permissions policy')) {
         setCaptureError("Browser security blocked direct capture. Please take a screenshot manually and drag it below.");
         const uploadSection = document.getElementById('manual-upload');
         if (uploadSection) {
             uploadSection.scrollIntoView({ behavior: 'smooth' });
             uploadSection.classList.add('ring-2', 'ring-fin-accent');
             setTimeout(() => uploadSection.classList.remove('ring-2', 'ring-fin-accent'), 2000);
         }
         return;
      }
      setCaptureError("Screen capture failed. Please upload manually.");
    }
  };

  return (
    <div className="min-h-screen bg-black text-gray-200 font-sans selection:bg-fin-accent/30 selection:text-fin-accent">
      <aside className="fixed top-0 left-0 h-full w-64 bg-fin-panel border-r border-fin-border hidden lg:flex flex-col z-50">
         <div className="p-6 border-b border-fin-border flex items-center gap-3">
            <Activity className="w-8 h-8 text-fin-accent" />
            <div>
               <h1 className="text-xl font-bold text-white tracking-tight">QUANTICAST</h1>
            </div>
         </div>
         <div className="p-4 space-y-1">
            <div className="text-xs font-bold text-gray-500 uppercase px-4 mb-2 tracking-widest">Main Menu</div>
            <button onClick={navigateToUpload} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${state.step !== 'REPORTS' ? 'bg-fin-accent text-white shadow-[0_0_20px_rgba(59,130,246,0.3)]' : 'text-gray-400 hover:bg-fin-card hover:text-white'}`}>
              <LayoutDashboard className="w-5 h-5" /> Dashboard
            </button>
            <button onClick={navigateToHistory} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${state.step === 'REPORTS' ? 'bg-fin-accent text-white shadow-[0_0_20px_rgba(59,130,246,0.3)]' : 'text-gray-400 hover:bg-fin-card hover:text-white'}`}>
              <History className="w-5 h-5" /> Reports
            </button>
         </div>
         <div className="mt-auto p-4 border-t border-fin-border">
            <div className="flex items-center gap-3 px-2">
               <div className="w-10 h-10 rounded-full bg-fin-accent/20 flex items-center justify-center text-fin-accent font-bold">PM</div>
               <div>
                  <div className="text-sm font-bold text-white">Portfolio Manager</div>
                  <div className="text-xs text-gray-500">Super Admin</div>
               </div>
            </div>
         </div>
      </aside>

      <div className="lg:ml-64 min-h-screen flex flex-col">
        <header className="h-16 border-b border-fin-border bg-fin-panel/50 backdrop-blur-md sticky top-0 z-40 px-8 flex items-center justify-between">
           <div className="flex-1 max-w-md">
              <input type="text" placeholder="Search ticker (e.g. BTCUSD)..." className="w-full bg-fin-dark border border-fin-border rounded-lg px-4 py-2 text-sm text-gray-200 focus:outline-none focus:border-fin-accent transition-colors" onKeyDown={handleSearch} />
           </div>
           <div className="flex items-center gap-4">
              <button onClick={() => window.open('/DOCUMENTATION.md', '_blank')} className="flex items-center gap-2 px-3 py-1.5 text-gray-400 hover:text-white hover:bg-fin-border rounded-lg transition-colors text-sm font-medium">
                <BookOpen className="w-4 h-4" /> Documentation
              </button>
           </div>
        </header>

        <main className="flex-1 p-8 overflow-y-auto">
          {state.step === 'REPORTS' && <ReportsView history={history} onView={handleViewReport} onDelete={handleDeleteReport} />}

          {(state.step === 'UPLOAD') && (
            <div className="max-w-7xl mx-auto space-y-8 animate-fade-in">
              <div className="space-y-4">
                 <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold text-white flex items-center gap-3"><Activity className="w-6 h-6 text-fin-accent" /> Market Context</h2>
                    <div className="flex items-center gap-4">
                       {captureError && <span className="text-xs text-fin-bear font-bold bg-fin-bear/10 px-3 py-1 rounded-full animate-pulse">{captureError}</span>}
                       <button onClick={captureActiveChart} className="flex items-center gap-2 px-4 py-2 bg-fin-accent hover:bg-blue-600 text-white rounded-lg font-bold text-sm transition-all shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:shadow-[0_0_25px_rgba(59,130,246,0.5)]">
                         <Camera className="w-4 h-4" /> Scan Active Chart
                       </button>
                    </div>
                 </div>
                 
                 <div className="rounded-2xl border border-fin-border overflow-hidden shadow-2xl bg-fin-card h-[450px]">
                    <TradingViewWidget symbol={activeTicker} />
                 </div>
              </div>

              <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                 <div className="xl:col-span-2 space-y-8">
                    <div className="bg-fin-card border border-fin-border rounded-2xl p-6">
                       <h3 className="text-lg font-bold text-gray-200 mb-6 flex items-center gap-2"><Terminal className="w-5 h-5 text-gray-400" /> 1. Select Framework</h3>
                       <StrategySelector selected={state.selectedStrategy} onSelect={handleStrategySelect} />
                    </div>
                    <div id="manual-upload" className="bg-fin-card border border-fin-border rounded-2xl p-6 transition-all duration-500">
                       <h3 className="text-lg font-bold text-gray-200 mb-6 flex items-center gap-2"><Camera className="w-5 h-5 text-gray-400" /> 2. Manual Upload (Optional)</h3>
                       <div className="flex justify-center"><FileUpload onFileSelect={handleFileSelect} /></div>
                    </div>
                 </div>

                 <div className="xl:col-span-1 space-y-6">
                    <div className="bg-fin-card border border-fin-border rounded-2xl p-6">
                        <h3 className="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                           <Newspaper className="w-5 h-5 text-fin-accent" />
                           Market Intelligence
                        </h3>
                        <TradingViewNews symbol={activeTicker} />
                    </div>

                    <div className="bg-fin-card border border-fin-border rounded-2xl p-6">
                       <h3 className="text-lg font-bold text-gray-200 mb-4">Recent Reports</h3>
                       <div className="space-y-3">
                          {history.slice(0, 3).map(report => (
                             <div key={report.id} onClick={() => handleViewReport(report)} className="flex items-center justify-between p-3 rounded-lg bg-fin-dark border border-fin-border hover:border-fin-accent cursor-pointer transition-all group">
                                <div className="flex items-center gap-3">
                                   <div className={`w-8 h-8 rounded flex items-center justify-center font-bold text-xs ${report.grade.includes('A') ? 'bg-fin-bull/20 text-fin-bull' : 'bg-gray-700 text-gray-400'}`}>{report.grade}</div>
                                   <div><div className="font-bold text-white text-sm">{report.ticker}</div><div className="text-xs text-gray-500">{new Date(report.timestamp).toLocaleTimeString()}</div></div>
                                </div>
                                <span className={`text-xs font-bold px-2 py-1 rounded ${report.bias === 'LONG' ? 'bg-fin-bull/10 text-fin-bull' : 'bg-fin-bear/10 text-fin-bear'}`}>{report.bias}</span>
                             </div>
                          ))}
                          {history.length === 0 && <div className="text-center py-8 text-gray-500 text-sm">No recent activity</div>}
                       </div>
                    </div>
                 </div>
              </div>
            </div>
          )}

          {(state.step === 'VALIDATING' || state.step === 'ANALYZING') && (
             <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-fade-in">
                <div className="relative"><div className="absolute inset-0 bg-fin-accent/20 blur-xl rounded-full"></div><Loader2 className="w-20 h-20 text-fin-accent animate-spin relative z-10" /></div>
                <div><h2 className="text-3xl font-bold text-white mb-2">{state.step === 'VALIDATING' ? 'Validating Asset...' : 'Running Quant Models...'}</h2><p className="text-gray-400 max-w-md mx-auto">{state.step === 'VALIDATING' ? 'Extracting price data.' : `Applying ${state.selectedStrategy} framework.`}</p></div>
                <div className="w-full max-w-lg bg-fin-panel border border-fin-border rounded-lg p-4 font-mono text-xs text-left text-gray-400 h-48 overflow-y-auto custom-scrollbar">{state.logs.map((log, i) => <div key={i} className="mb-1">{log}</div>)}</div>
             </div>
          )}

          {state.step === 'ERROR' && (
            <div className="flex flex-col items-center justify-center min-h-[50vh] text-center animate-fade-in">
               <div className="w-20 h-20 bg-fin-bear/10 rounded-full flex items-center justify-center mb-6 border border-fin-bear/30"><AlertCircle className="w-10 h-10 text-fin-bear" /></div>
               <h2 className="text-3xl font-bold text-white mb-4">Analysis Failed</h2>
               <p className="text-gray-400 max-w-lg mb-8">{state.error}</p>
               <button onClick={handleReset} className="px-6 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2"><ArrowLeft className="w-4 h-4" /> Try Again</button>
            </div>
          )}

          {state.step === 'RESULTS' && state.analysisData && state.validationData && (
            <div className="space-y-6 max-w-7xl mx-auto">
              <button onClick={handleReset} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4"><ArrowLeft className="w-4 h-4" /> Back to Dashboard</button>
              <AnalysisView validation={state.validationData} analysis={state.analysisData} imagePreview={state.imagePreviewUrl} strategy={state.selectedStrategy} />
            </div>
          )}
        </main>
      </div>
    </div>
  );
};
export default App;
EOF

echo "âœ… History Engine logic updated to Strict FIFO (Max 10)."